<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام حجز الطيران — أمان للسفريات</title>

  <!-- خطوط وأيقونات -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --bg1: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --bg2: linear-gradient(135deg,#764ba2 0%,#667eea 100%);
      --card:#fff; --primary:#2563eb; --accent:#f59e0b; --muted:#64748b;
      --success:#10b981; --danger:#ef4444; --radius:12px; --shadow:0 10px 30px rgba(2,6,23,0.12);
      --shadow-hover:0 15px 40px rgba(2,6,23,0.2);
      font-family: 'Tajawal', sans-serif;
    }
    body{margin:0;padding:28px;background:var(--bg1);color:#0f172a;min-height:100vh}
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);overflow:hidden;transition:all 0.4s ease}
    .card:hover{box-shadow:var(--shadow-hover);transform:translateY(-5px)}
    .hero{padding:20px;background:linear-gradient(90deg,var(--primary),#7c3aed);color:#fff;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;position:relative;overflow:hidden}
    .hero::before{content:'';position:absolute;top:0;right:0;width:100%;height:100%;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');background-size:cover}
    .brand{font-weight:700;font-size:1.3rem;display:flex;gap:10px;align-items:center;z-index:1}
    .content{padding:20px}
    .tabs{display:flex;background:#f1f5f9;border-radius:10px;padding:6px;gap:6px;margin-bottom:18px}
    .tab{flex:1;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:600;transition:all 0.3s;position:relative;overflow:hidden}
    .tab::after{content:'';position:absolute;top:50%;left:50%;width:5px;height:5px;background:rgba(255,255,255,0.5);opacity:0;border-radius:100%;transform:scale(1,1) translate(-50%);transform-origin:50% 50%;}
    .tab:active::after{animation:ripple 1s ease-out;}
    .tab[aria-pressed="true"]{background:#fff;box-shadow:0 6px 18px rgba(2,6,23,0.06);color:var(--primary)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
    .form-group{display:flex;flex-direction:column;gap:6px}
    label{font-weight:600;display:flex;align-items:center;gap:6px}
    select,input{padding:10px;border-radius:10px;border:1px solid #ddd;font-family:inherit;transition:all 0.3s}
    select:focus, input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37, 99, 235, 0.1)}
    .select-wrapper{position:relative}
    .select-wrapper i{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted)}
    .select-wrapper select{padding-right:10px;padding-left:40px;width:100%}
    .search-box{position:relative;margin-bottom:12px}
    .search-box input{width:100%;padding:10px 40px 10px 10px;border-radius:8px;border:1px solid #ddd}
    .search-box i{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted)}
    .btn{padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:700;border:none;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px;position:relative;overflow:hidden}
    .btn::after{content:'';position:absolute;top:50%;left:50%;width:5px;height:5px;background:rgba(255,255,255,0.5);opacity:0;border-radius:100%;transform:scale(1,1) translate(-50%);transform-origin:50% 50%;}
    .btn:active::after{animation:ripple 1s ease-out;}
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
    .btn-primary{background:linear-gradient(90deg,var(--primary),#7c3aed);color:#fff}
    .btn-whatsapp{background:linear-gradient(90deg,#25d366,#128c7e);color:#fff}
    .btn-ghost{background:#fff;border:1px solid #eee}
    .summary{margin-top:16px;padding:16px;background:#f8fafc;border-radius:12px;border:1px solid #eef2ff;display:none;animation:fadeIn 0.5s ease}
    .summary-content{display:flex;flex-direction:column;gap:12px}
    .summary-row{display:flex;align-items:center;gap:10px;padding:8px 0}
    .summary-row i{color:var(--primary);font-size:1.2rem}
    .flight-direction{display:flex;align-items:center;gap:8px;margin:10px 0;padding:10px;background:rgba(255,255,255,0.7);border-radius:10px;border-left:4px solid var(--accent)}
    .flight-direction i{color:var(--accent);font-size:1.4rem}
    .toast{position:fixed;left:20px;bottom:20px;background:#111;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 8px 28px rgba(2,6,23,0.3);display:none;z-index:1000;animation:slideInLeft 0.3s ease, slideOutLeft 0.3s ease 2.7s}
    .option-with-icon{display:flex;align-items:center;gap:8px}
    .option-with-icon i{color:var(--muted)}
    .recent-searches{margin-top:20px;padding:16px;background:#f8fafc;border-radius:12px;border:1px solid #eef2ff;animation:fadeIn 0.5s ease}
    .recent-title{font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:8px}
    .recent-list{display:flex;flex-wrap:wrap;gap:10px}
    .recent-item{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:8px 12px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:6px}
    .recent-item:hover{background:#f1f5f9;border-color:var(--primary);transform:translateY(-2px)}
    .recent-item i{color:var(--primary)}
    .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;z-index:2000}
    .loading-plane{font-size:3rem;color:#fff;animation:fly 2s infinite}
    .flight-path{position:relative;height:4px;background:#e2e8f0;border-radius:2px;margin:20px 0;overflow:hidden}
    .flight-path::before{content:'';position:absolute;top:0;right:0;height:100%;width:30%;background:var(--primary);border-radius:2px;animation:travel 3s infinite}
    .flight-timeline{display:flex;justify-content:space-between;margin-top:10px}
    .timeline-point{display:flex;flex-direction:column;align-items:center;gap:5px}
    .point{width:12px;height:12px;border-radius:50%;background:#e2e8f0}
    .point.active{background:var(--primary)}
    .timeline-label{font-size:0.8rem;color:var(--muted)}
    .confetti{position:fixed;width:10px;height:10px;background:var(--primary);opacity:0;z-index:3000}
    .pulse{animation:pulse 2s infinite}
    
    /* تحسينات متقدمة لقائمة الدول */
    .country-select-wrapper {
      position: relative;
      margin-bottom: 8px;
    }

    .country-select-trigger {
      background: #fff;
      border: 1.5px solid #e2e8f0;
      border-radius: 12px;
      padding: 14px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .country-select-trigger:hover {
      border-color: var(--primary);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.08);
    }

    .country-select-trigger:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    .country-select-trigger.active {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .selected-country {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
      color: #0f172a;
    }

    .selected-country i {
      color: var(--primary);
      font-size: 1.1rem;
      transition: transform 0.3s ease;
    }

    .country-select-trigger.active .selected-country i {
      transform: rotate(180deg);
    }

    .placeholder {
      color: #94a3b8;
      font-weight: 400;
    }

    .chevron {
      color: var(--muted);
      transition: transform 0.3s ease;
      font-size: 0.9rem;
    }

    .country-select-trigger.active .chevron {
      transform: rotate(180deg);
      color: var(--primary);
    }

    .country-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1.5px solid #e2e8f0;
      border-radius: 12px;
      margin-top: 8px;
      box-shadow: 0 10px 25px rgba(2, 6, 23, 0.15);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-height: 300px;
      overflow: hidden;
    }

    .country-dropdown.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .country-search-box {
      padding: 16px;
      border-bottom: 1px solid #f1f5f9;
      background: #fafbfc;
    }

    .country-search-input {
      width: 100%;
      padding: 12px 16px;
      border: 1.5px solid #e2e8f0;
      border-radius: 10px;
      font-family: inherit;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background: #fff;
    }

    .country-search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .country-search-input::placeholder {
      color: #94a3b8;
    }

    .country-list {
      max-height: 250px;
      overflow-y: auto;
      padding: 8px;
    }

    .country-list::-webkit-scrollbar {
      width: 6px;
    }

    .country-list::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }

    .country-list::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    .country-list::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .country-item {
      padding: 14px 16px;
      cursor: pointer;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s ease;
      margin-bottom: 4px;
      border: 1.5px solid transparent;
    }

    .country-item:hover {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-color: #e2e8f0;
      transform: translateX(4px);
    }

    .country-item.selected {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border-color: var(--primary);
      color: var(--primary);
    }

    .country-item.selected .country-flag {
      transform: scale(1.1);
    }

    .country-flag {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 1.1rem;
      transition: transform 0.2s ease;
    }

    .country-name {
      font-weight: 500;
      color: #0f172a;
      flex: 1;
    }

    .country-item.selected .country-name {
      color: var(--primary);
      font-weight: 600;
    }

    .country-code {
      color: #94a3b8;
      font-size: 0.85rem;
      font-weight: 500;
      background: #f1f5f9;
      padding: 4px 8px;
      border-radius: 6px;
      min-width: 40px;
      text-align: center;
    }

    .country-item.selected .country-code {
      background: var(--primary);
      color: #fff;
    }

    .no-results {
      padding: 20px;
      text-align: center;
      color: #94a3b8;
      font-style: italic;
    }

    .no-results i {
      font-size: 1.5rem;
      margin-bottom: 8px;
      display: block;
    }

    .country-list-old{max-height:200px;overflow-y:auto;border:1px solid #ddd;border-radius:8px;margin-top:5px;display:none;position:absolute;width:100%;background:white;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    .country-item-old{padding:10px;cursor:pointer;border-bottom:1px solid #f1f5f9;display:flex;align-items:center;gap:8px}
    .country-item-old:hover{background:#f8fafc}
    .country-item-old:last-child{border-bottom:none}
    
    @keyframes ripple{0%{transform:scale(0, 0);opacity:1;}20%{transform:scale(25, 25);opacity:1;}100%{opacity:0;transform:scale(40, 40);}}
    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
    @keyframes slideInLeft{from{transform:translateX(-100%);opacity:0;}to{transform:translateX(0);opacity:1;}}
    @keyframes slideOutLeft{from{transform:translateX(0);opacity:1;}to{transform:translateX(-100%);opacity:0;}}
    @keyframes fly{0%{transform:translateX(-50px) rotate(0deg);}50%{transform:translateX(50px) rotate(10deg);}100%{transform:translateX(-50px) rotate(0deg);}}
    @keyframes travel{0%{right:100%;}100%{right:0;}}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(37, 99, 235, 0.7);}70%{box-shadow:0 0 0 10px rgba(37, 99, 235, 0);}100%{box-shadow:0 0 0 0 rgba(37, 99, 235, 0);}}
    @keyframes confettiFall{0%{transform:translateY(-100px) rotate(0deg);opacity:1;}100%{transform:translateY(1000px) rotate(360deg);opacity:0;}}
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes slideOutDown {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(20px);
      }
    }
    
    /* تحسينات للهواتف */
    @media (max-width: 768px) {
      body{padding:15px;}
      .hero{flex-direction:column;gap:15px;text-align:center;}
      .tabs{flex-direction:column;}
      .grid{grid-template-columns:1fr;}
      .country-list-old{position:relative;width:calc(100% - 2px)}
      
      .country-select-trigger {
        padding: 12px 14px;
      }
      
      .country-dropdown {
        position: fixed;
        top: 50%;
        left: 20px;
        right: 20px;
        transform: translateY(-40%);
        max-height: 60vh;
      }
      
      .country-dropdown.active {
        transform: translateY(-50%);
      }
      
      .country-item {
        padding: 12px 14px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header class="hero">
        <div class="brand"><i class="fas fa-plane-departure"></i> نظام حجز الطيران — أمان للسفريات</div>
        <button id="open-demo" class="btn btn-ghost"><i class="fas fa-history"></i> استرجاع آخر بحث</button>
      </header>
      <div class="content">
        <!-- Tabs -->
        <div class="tabs">
          <button class="tab" data-type="round" aria-pressed="true"><i class="fas fa-exchange-alt"></i> ذهاب وعودة</button>
          <button class="tab" data-type="oneway" aria-pressed="false"><i class="fas fa-long-arrow-alt-right"></i> ذهاب فقط</button>
        </div>

        <!-- Form -->
        <form id="flightForm" autocomplete="off">
          <!-- Origin Section -->
          <div class="grid">
            <div class="form-group">
              <label><i class="fas fa-globe-asia"></i> الدولة الأصل</label>
              <div class="country-select-wrapper" id="originCountryWrapper">
                <div class="country-select-trigger" id="originCountryTrigger">
                  <div class="selected-country">
                    <i class="fas fa-flag"></i>
                    <span class="placeholder">اختر الدولة الأصل</span>
                  </div>
                  <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="country-dropdown" id="originCountryDropdown">
                  <div class="country-search-box">
                    <input type="text" class="country-search-input" id="originCountrySearch" placeholder="ابحث عن الدولة...">
                  </div>
                  <div class="country-list" id="originCountryList"></div>
                </div>
                <select id="originCountry" style="display: none;">
                  <option value="">اختر الدولة</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label><i class="fas fa-city"></i> المدينة الأصل</label>
              <div class="select-wrapper">
                <i class="fas fa-building"></i>
                <select id="originCity" disabled>
                  <option value="">اختر المدينة</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label><i class="fas fa-plane-departure"></i> مطار الانطلاق</label>
              <div class="select-wrapper">
                <i class="fas fa-plane"></i>
                <select id="originAirport" disabled>
                  <option value="">اختر المطار</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Destination Section -->
          <div class="grid" style="margin-top:20px">
            <div class="form-group">
              <label><i class="fas fa-globe-asia"></i> دولة الوجهة</label>
              <div class="country-select-wrapper" id="destinationCountryWrapper">
                <div class="country-select-trigger" id="destinationCountryTrigger">
                  <div class="selected-country">
                    <i class="fas fa-flag"></i>
                    <span class="placeholder">اختر دولة الوجهة</span>
                  </div>
                  <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="country-dropdown" id="destinationCountryDropdown">
                  <div class="country-search-box">
                    <input type="text" class="country-search-input" id="destinationCountrySearch" placeholder="ابحث عن الدولة...">
                  </div>
                  <div class="country-list" id="destinationCountryList"></div>
                </div>
                <select id="destinationCountry" style="display: none;">
                  <option value="">اختر الدولة</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label><i class="fas fa-city"></i> المدينة الوجهة</label>
              <div class="select-wrapper">
                <i class="fas fa-building"></i>
                <select id="destinationCity" disabled>
                  <option value="">اختر المدينة</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label><i class="fas fa-plane-arrival"></i> مطار الوجهة</label>
              <div class="select-wrapper">
                <i class="fas fa-plane"></i>
                <select id="destinationAirport" disabled>
                  <option value="">اختر المطار</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Date & Options -->
          <div class="grid" style="margin-top:20px">
            <div class="form-group">
              <label><i class="fas fa-calendar-alt"></i> تاريخ المغادرة</label>
              <input type="date" id="departureDate" required>
            </div>
            <div class="form-group" id="returnGroup">
              <label><i class="fas fa-calendar-check"></i> تاريخ العودة</label>
              <input type="date" id="returnDate">
            </div>
            <div class="form-group">
              <label><i class="fas fa-users"></i> المسافرون</label>
              <div class="select-wrapper">
                <i class="fas fa-user"></i>
                <select id="passengers">
                  <option value="1">1 مسافر</option>
                  <option value="2">2 مسافرين</option>
                  <option value="3">3 مسافرين</option>
                  <option value="4">4 مسافرين</option>
                  <option value="5">5 مسافرين</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label><i class="fas fa-couch"></i> الفئة</label>
              <div class="select-wrapper">
                <i class="fas fa-star"></i>
                <select id="flightClass">
                  <option value="economy">اقتصادية</option>
                  <option value="business">رجال الأعمال</option>
                  <option value="first">الأولى</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap">
            <button type="button" id="searchBtn" class="btn btn-primary"><i class="fas fa-search"></i> بحث عن الرحلات</button>
            <button type="reset" id="resetBtn" class="btn btn-ghost"><i class="fas fa-eraser"></i> تفريغ النموذج</button>
          </div>
        </form>

        <!-- Recent Searches -->
        <div class="recent-searches" id="recentSearches" style="display:none">
          <div class="recent-title"><i class="fas fa-history"></i> عمليات البحث الأخيرة</div>
          <div class="recent-list" id="recentList"></div>
        </div>

        <!-- Summary -->
        <div id="resultArea" class="summary">
          <div class="summary-content">
            <div class="summary-row">
              <i class="fas fa-info-circle"></i>
              <span><strong>نوع الرحلة:</strong> <span id="summaryType"></span></span>
            </div>
            
            <div class="flight-direction">
              <i class="fas fa-long-arrow-alt-right"></i>
              <span><strong>من:</strong> <span id="summaryOrigin"></span></span>
            </div>
            
            <div class="flight-direction" id="returnDirection" style="display:none">
              <i class="fas fa-long-arrow-alt-left"></i>
              <span><strong>إلى:</strong> <span id="summaryDestination"></span></span>
            </div>
            
            <div class="summary-row">
              <i class="fas fa-calendar-alt"></i>
              <span><strong>تاريخ المغادرة:</strong> <span id="summaryDeparture"></span></span>
            </div>
            
            <div class="summary-row" id="summaryReturnRow" style="display:none">
              <i class="fas fa-calendar-check"></i>
              <span><strong>تاريخ العودة:</strong> <span id="summaryReturn"></span></span>
            </div>
            
            <div class="summary-row">
              <i class="fas fa-users"></i>
              <span><strong>عدد المسافرين:</strong> <span id="summaryPassengers"></span></span>
            </div>
            
            <div class="summary-row">
              <i class="fas fa-couch"></i>
              <span><strong>فئة الرحلة:</strong> <span id="summaryClass"></span></span>
            </div>
            
            <!-- مخطط الرحلة المحسن -->
            <div class="flight-path">
              <div class="flight-timeline">
                <div class="timeline-point">
                  <div class="point active"></div>
                  <div class="timeline-label" id="timelineOrigin"></div>
                </div>
                <div class="timeline-point">
                  <div class="point"></div>
                  <div class="timeline-label">في الطريق</div>
                </div>
                <div class="timeline-point">
                  <div class="point"></div>
                  <div class="timeline-label" id="timelineDestination"></div>
                </div>
              </div>
            </div>
            
            <button class="btn btn-whatsapp pulse" onclick="sendWhatsApp()"><i class="fab fa-whatsapp"></i> إرسال الطلب عبر واتساب</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- شاشة التحميل -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-plane">
      <i class="fas fa-plane"></i>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const CONTACT_PHONE = '967781333149'; // ضع رقم الواتساب
    const tabs = document.querySelectorAll('.tab');
    let tripType = 'round';

    // العناصر الرئيسية
    const originCountry = document.getElementById('originCountry');
    const originCity = document.getElementById('originCity');
    const originAirport = document.getElementById('originAirport');
    const destinationCountry = document.getElementById('destinationCountry');
    const destinationCity = document.getElementById('destinationCity');
    const destinationAirport = document.getElementById('destinationAirport');
    const departureDate = document.getElementById('departureDate');
    const returnDate = document.getElementById('returnDate');
    const returnGroup = document.getElementById('returnGroup');
    const resultArea = document.getElementById('resultArea');
    const toast = document.getElementById('toast');
    const recentSearches = document.getElementById('recentSearches');
    const recentList = document.getElementById('recentList');
    const loadingOverlay = document.getElementById('loadingOverlay');

    let data = [];
    let recentSearchesData = JSON.parse(localStorage.getItem('recentSearches')) || [];

    // تعيين تاريخ اليوم كحد أدنى
    const today = new Date().toISOString().split('T')[0];
    departureDate.min = today;
    returnDate.min = today;

    // دالة تهيئة القائمة المنسدلة للدول
    function initializeCountrySelect(wrapperId, triggerId, dropdownId, searchId, listId, hiddenSelectId) {
      const wrapper = document.getElementById(wrapperId);
      const trigger = document.getElementById(triggerId);
      const dropdown = document.getElementById(dropdownId);
      const searchInput = document.getElementById(searchId);
      const list = document.getElementById(listId);
      const hiddenSelect = document.getElementById(hiddenSelectId);
      
      let countries = [];
      let selectedCountry = null;

      // فتح/إغلاق القائمة المنسدلة
      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        const isActive = dropdown.classList.contains('active');
        
        // إغلاق جميع القوائم المنسدلة الأخرى
        document.querySelectorAll('.country-dropdown.active').forEach(dd => {
          if (dd !== dropdown) {
            dd.classList.remove('active');
            dd.previousElementSibling.classList.remove('active');
          }
        });
        
        if (isActive) {
          closeDropdown();
        } else {
          openDropdown();
        }
      });

      // إغلاق القائمة عند النقر خارجها
      document.addEventListener('click', (e) => {
        if (!wrapper.contains(e.target)) {
          closeDropdown();
        }
      });

      function openDropdown() {
        dropdown.classList.add('active');
        trigger.classList.add('active');
        searchInput.focus();
        dropdown.style.animation = 'slideInUp 0.3s ease';
      }

      function closeDropdown() {
        dropdown.style.animation = 'slideOutDown 0.3s ease';
        setTimeout(() => {
          dropdown.classList.remove('active');
          trigger.classList.remove('active');
        }, 250);
      }

      // البحث في القائمة
      searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        filterCountries(searchTerm);
      });

      function filterCountries(searchTerm) {
        const filtered = countries.filter(country => 
          country.name.toLowerCase().includes(searchTerm) ||
          country.code.toLowerCase().includes(searchTerm)
        );
        
        renderCountryList(filtered);
      }

      function renderCountryList(countriesList) {
        list.innerHTML = '';
        
        if (countriesList.length === 0) {
          const noResults = document.createElement('div');
          noResults.className = 'no-results';
          noResults.innerHTML = `
            <i class="fas fa-search"></i>
            <div>لا توجد نتائج</div>
          `;
          list.appendChild(noResults);
          return;
        }
        
        countriesList.forEach(country => {
          const item = document.createElement('div');
          item.className = `country-item ${selectedCountry === country.index ? 'selected' : ''}`;
          item.innerHTML = `
            <div class="country-flag">
              <i class="fas fa-flag"></i>
            </div>
            <div class="country-name">${country.name}</div>
            <div class="country-code">${country.code}</div>
          `;
          
          item.addEventListener('click', () => {
            selectCountry(country);
            closeDropdown();
            searchInput.value = '';
            filterCountries('');
          });
          
          list.appendChild(item);
        });
      }

      function selectCountry(country) {
        selectedCountry = country.index;
        
        // تحديث الواجهة
        const selectedElement = trigger.querySelector('.selected-country');
        selectedElement.innerHTML = `
          <i class="fas fa-flag"></i>
          <span>${country.name}</span>
        `;
        
        // تحديث الـ select المخفي
        hiddenSelect.value = country.index;
        
        // تحديث المدن والمطارات
        if (hiddenSelectId === 'originCountry') {
          updateCities(hiddenSelect, document.getElementById('originCity'), document.getElementById('originAirport'));
        } else {
          updateCities(hiddenSelect, document.getElementById('destinationCity'), document.getElementById('destinationAirport'));
        }
        
        // إعادة عرض القائمة
        renderCountryList(countries);
      }

      // تهيئة البيانات
      function initializeData(countriesData) {
        countries = countriesData.map((country, index) => ({
          index: index,
          name: country["الدولة"],
          code: country["رمز الدولة"] || '--'
        }));
        
        renderCountryList(countries);
      }

      return {
        initializeData,
        getSelectedCountry: () => selectedCountry
      };
    }

    // تهيئة القوائم المنسدلة
    const originCountrySelect = initializeCountrySelect(
      'originCountryWrapper',
      'originCountryTrigger',
      'originCountryDropdown',
      'originCountrySearch',
      'originCountryList',
      'originCountry'
    );

    const destinationCountrySelect = initializeCountrySelect(
      'destinationCountryWrapper',
      'destinationCountryTrigger',
      'destinationCountryDropdown',
      'destinationCountrySearch',
      'destinationCountryList',
      'destinationCountry'
    );

    // تحميل JSON
    async function loadData(){
      showLoading();
      try{
        // محاولة تحميل البيانات من ملف JSON
        const response = await fetch('airports.json');
        
        if (!response.ok) {
          throw new Error('فشل في تحميل البيانات');
        }
        
        data = await response.json();
        
        // تهيئة القوائم المنسدلة الجديدة
        originCountrySelect.initializeData(data);
        destinationCountrySelect.initializeData(data);
        
        // الاحتفاظ بالدالة القديمة للتوافق
        populateCountries();
        
        updateRecentSearches();
        hideLoading();
        showToast('تم تحميل البيانات بنجاح', 'success');
        
      } catch(e) {
        hideLoading();
        showToast('فشل تحميل بيانات المطارات. تأكد من وجود ملف airports.json', 'error');
        console.error('Error loading data:', e);
        
        // لا نضع بيانات افتراضية - نترك المستخدم يرى رسالة الخطأ
        data = [];
      }
    }

    // الاحتفاظ بالدالة القديمة للتوافق
    function populateCountries(){
      [originCountry, destinationCountry].forEach(sel => {
        sel.innerHTML = '<option value="">اختر الدولة</option>';
        if (data && data.length > 0) {
          data.forEach((c, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            const flagIcon = getCountryFlagIcon(c["رمز الدولة"]);
            opt.innerHTML = `<span class="option-with-icon">${flagIcon} ${c["الدولة"]}</span>`;
            sel.appendChild(opt);
          });
        }
      });
    }

    // الحصول على أيقونة العلم حسب رمز الدولة
    function getCountryFlagIcon(countryCode) {
      // في التطبيق الحقيقي، يمكن استخدام مكتبة الأعلام
      // هنا نستخدم أيقونات بديلة
      return `<i class="fas fa-flag"></i>`;
    }

    // تحديث المدن بناءً على الدولة المختارة
    function updateCities(countrySel, citySel, airportSel){
      citySel.innerHTML = '<option value="">اختر المدينة</option>';
      airportSel.innerHTML = '<option value="">اختر المطار</option>';
      airportSel.disabled = true;
      citySel.disabled = true;
      
      if(!countrySel.value || !data || data.length === 0) return;
      
      const country = data[countrySel.value];
      if (country && country["مدن"]) {
        country["مدن"].forEach((ct, ci) => {
          const opt = document.createElement('option');
          opt.value = ci;
          opt.innerHTML = `<span class="option-with-icon"><i class="fas fa-city"></i> ${ct["المدينة"]}</span>`;
          citySel.appendChild(opt);
        });
        citySel.disabled = false;
      }
    }

    // تحديث المطارات بناءً على المدينة المختارة
    function updateAirports(countrySel, citySel, airportSel){
      airportSel.innerHTML = '<option value="">اختر المطار</option>';
      airportSel.disabled = true;
      
      if(!citySel.value || !data || data.length === 0) return;
      
      const country = data[countrySel.value];
      if (country && country["مدن"] && country["مدن"][citySel.value]) {
        const city = country["مدن"][citySel.value];
        if (city["المطارات"]) {
          city["المطارات"].forEach(ap => {
            const opt = document.createElement('option');
            opt.value = ap["الرمز"];
            opt.innerHTML = `<span class="option-with-icon"><i class="fas fa-plane"></i> ${ap["الاسم"]} (${ap["الرمز"]})</span>`;
            airportSel.appendChild(opt);
          });
          airportSel.disabled = false;
        }
      }
    }

    // تحديث عمليات البحث الأخيرة
    function updateRecentSearches() {
      if (recentSearchesData.length === 0) {
        recentSearches.style.display = 'none';
        return;
      }
      
      recentSearches.style.display = 'block';
      recentList.innerHTML = '';
      
      // عرض آخر 5 عمليات بحث فقط
      const recentToShow = recentSearchesData.slice(-5).reverse();
      
      recentToShow.forEach(search => {
        const item = document.createElement('div');
        item.className = 'recent-item';
        item.innerHTML = `
          <i class="fas fa-plane"></i>
          <span>${search.origin} → ${search.destination}</span>
        `;
        item.onclick = () => loadRecentSearch(search);
        recentList.appendChild(item);
      });
    }

    // تحميل بحث سابق
    function loadRecentSearch(search) {
      if (!data || data.length === 0) {
        showToast('لا يمكن تحميل البحث السابق - البيانات غير متوفرة', 'error');
        return;
      }
      
      // البحث عن الدولة الأصل
      const originCountryIndex = data.findIndex(country => 
        country["مدن"].some(city => 
          city["المطارات"].some(airport => airport["الرمز"] === search.originAirport)
        )
      );
      
      if (originCountryIndex !== -1) {
        originCountry.value = originCountryIndex;
        updateCities(originCountry, originCity, originAirport);
        
        // البحث عن المدينة الأصل
        const originCityIndex = data[originCountryIndex]["مدن"].findIndex(city => 
          city["المطارات"].some(airport => airport["الرمز"] === search.originAirport)
        );
        
        if (originCityIndex !== -1) {
          originCity.value = originCityIndex;
          updateAirports(originCountry, originCity, originAirport);
          originAirport.value = search.originAirport;
        }
      }
      
      // البحث عن دولة الوجهة
      const destCountryIndex = data.findIndex(country => 
        country["مدن"].some(city => 
          city["المطارات"].some(airport => airport["الرمز"] === search.destinationAirport)
        )
      );
      
      if (destCountryIndex !== -1) {
        destinationCountry.value = destCountryIndex;
        updateCities(destinationCountry, destinationCity, destinationAirport);
        
        // البحث عن مدينة الوجهة
        const destCityIndex = data[destCountryIndex]["مدن"].findIndex(city => 
          city["المطارات"].some(airport => airport["الرمز"] === search.destinationAirport)
        );
        
        if (destCityIndex !== -1) {
          destinationCity.value = destCityIndex;
          updateAirports(destinationCountry, destinationCity, destinationAirport);
          destinationAirport.value = search.destinationAirport;
        }
      }
      
      // تعيين نوع الرحلة
      tripType = search.tripType;
      tabs.forEach(t => t.setAttribute('aria-pressed', t.dataset.type === tripType ? 'true' : 'false'));
      returnGroup.style.display = tripType === 'oneway' ? 'none' : 'block';
      
      showToast('تم تحميل البحث السابق', 'success');
    }

    // حفظ البحث الحالي
    function saveCurrentSearch() {
      if (!originAirport.value || !destinationAirport.value) return;
      
      const search = {
        tripType,
        originAirport: originAirport.value,
        destinationAirport: destinationAirport.value,
        origin: originAirport.selectedOptions[0]?.textContent || '',
        destination: destinationAirport.selectedOptions[0]?.textContent || '',
        date: new Date().toISOString()
      };
      
      // تجنب التكرار
      const exists = recentSearchesData.some(s => 
        s.originAirport === search.originAirport && 
        s.destinationAirport === search.destinationAirport && 
        s.tripType === search.tripType
      );
      
      if (!exists) {
        recentSearchesData.push(search);
        // الاحتفاظ بـ 10 عملية بحث فقط
        if (recentSearchesData.length > 10) {
          recentSearchesData = recentSearchesData.slice(-10);
        }
        localStorage.setItem('recentSearches', JSON.stringify(recentSearchesData));
        updateRecentSearches();
      }
    }

    // عرض الملخص
    function showSummary() {
      const originText = originAirport.selectedOptions[0]?.textContent || '';
      const destinationText = destinationAirport.selectedOptions[0]?.textContent || '';
      
      document.getElementById('summaryType').textContent = tripType === 'oneway' ? 'ذهاب فقط' : 'ذهاب وعودة';
      document.getElementById('summaryOrigin').textContent = originText;
      document.getElementById('summaryDestination').textContent = destinationText;
      document.getElementById('summaryDeparture').textContent = departureDate.value;
      document.getElementById('summaryPassengers').textContent = passengers.value + ' مسافر' + (passengers.value > 1 ? 'ين' : '');
      
      // تحديث مخطط الرحلة
      document.getElementById('timelineOrigin').textContent = originAirport.options[originAirport.selectedIndex].text.split('(')[0].trim();
      document.getElementById('timelineDestination').textContent = destinationAirport.options[destinationAirport.selectedIndex].text.split('(')[0].trim();
      
      const classNames = {
        'economy': 'اقتصادية',
        'business': 'رجال الأعمال',
        'first': 'الأولى'
      };
      document.getElementById('summaryClass').textContent = classNames[flightClass.value] || flightClass.value;
      
      if (tripType === 'round') {
        document.getElementById('summaryReturn').textContent = returnDate.value;
        document.getElementById('summaryReturnRow').style.display = 'flex';
        document.getElementById('returnDirection').style.display = 'flex';
      } else {
        document.getElementById('summaryReturnRow').style.display = 'none';
        document.getElementById('returnDirection').style.display = 'none';
      }
      
      resultArea.style.display = 'block';
      saveCurrentSearch();
      
      // إضافة تأثيرات جميلة
      createConfetti();
    }

    // إرسال الطلب عبر واتساب
    function sendWhatsApp(){
      const originText = originAirport.selectedOptions[0]?.textContent || '';
      const destinationText = destinationAirport.selectedOptions[0]?.textContent || '';
      
      let message = `طلب حجز رحلة طيران\n`;
      message += `نوع الرحلة: ${tripType === 'oneway' ? 'ذهاب فقط' : 'ذهاب وعودة'}\n`;
      message += `من: ${originText}\n`;
      message += `إلى: ${destinationText}\n`;
      message += `تاريخ المغادرة: ${departureDate.value}\n`;
      
      if (tripType === 'round') {
        message += `تاريخ العودة: ${returnDate.value}\n`;
      }
      
      message += `عدد المسافرين: ${passengers.value}\n`;
      
      const classNames = {
        'economy': 'اقتصادية',
        'business': 'رجال الأعمال',
        'first': 'الأولى'
      };
      message += `فئة الرحلة: ${classNames[flightClass.value] || flightClass.value}\n\n`;
      message += `أرغب في الحصول على تفاصيل أكثر عن هذه الرحلة.`;
      
      window.open(`https://wa.me/${CONTACT_PHONE}?text=${encodeURIComponent(message)}`, '_blank');
    }

    // عرض الإشعارات
    function showToast(message, type = 'info') {
      toast.textContent = message;
      
      // تغيير لون الإشعار حسب النوع
      if (type === 'success') {
        toast.style.background = 'linear-gradient(90deg, var(--success), #059669)';
      } else if (type === 'error') {
        toast.style.background = 'linear-gradient(90deg, var(--danger), #dc2626)';
      } else {
        toast.style.background = '#111';
      }
      
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }

    // إظهار شاشة التحميل
    function showLoading() {
      loadingOverlay.style.display = 'flex';
    }

    // إخفاء شاشة التحميل
    function hideLoading() {
      loadingOverlay.style.display = 'none';
    }

    // إنشاء تأثير الكونفيتي
    function createConfetti() {
      const colors = ['#2563eb', '#7c3aed', '#f59e0b', '#10b981', '#ef4444'];
      
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.width = Math.random() * 10 + 5 + 'px';
        confetti.style.height = Math.random() * 10 + 5 + 'px';
        confetti.style.animation = `confettiFall ${Math.random() * 3 + 2}s linear forwards`;
        
        document.body.appendChild(confetti);
        
        // إزالة الكونفيتي بعد انتهاء الرسوم المتحركة
        setTimeout(() => {
          confetti.remove();
        }, 5000);
      }
    }

    // استرجاع آخر بحث
    document.getElementById('open-demo').onclick = () => {
      if (recentSearchesData.length === 0) {
        showToast('لا يوجد بحث محفوظ', 'info');
        return;
      }
      
      const lastSearch = recentSearchesData[recentSearchesData.length - 1];
      loadRecentSearch(lastSearch);
    };

    // البحث عن رحلات
    document.getElementById('searchBtn').onclick = () => {
      if (!data || data.length === 0) {
        showToast('لا توجد بيانات متاحة للبحث', 'error');
        return;
      }
      
      if (!originAirport.value || !destinationAirport.value || !departureDate.value) {
        showToast('يرجى تعبئة جميع الحقول المطلوبة', 'error');
        return;
      }
      
      if (tripType === 'round' && !returnDate.value) {
        showToast('يرجى تحديد تاريخ العودة', 'error');
        return;
      }
      
      if (originAirport.value === destinationAirport.value) {
        showToast('لا يمكن أن تكون نقطة الانطلاق والوجهة نفسها', 'error');
        return;
      }
      
      showLoading();
      // محاكاة البحث عن الرحلات
      setTimeout(() => {
        hideLoading();
        showSummary();
        showToast('تم العثور على رحلات متاحة!', 'success');
      }, 2000);
    };

    // إعادة تعيين النموذج
    document.getElementById('resetBtn').onclick = () => {
      resultArea.style.display = 'none';
      
      // إعادة تعيين القوائم المنسدلة الجديدة
      document.querySelectorAll('.country-select-trigger').forEach(trigger => {
        const selectedElement = trigger.querySelector('.selected-country');
        selectedElement.innerHTML = `
          <i class="fas fa-flag"></i>
          <span class="placeholder">${trigger.closest('.form-group').querySelector('label').textContent.includes('الأصل') ? 'اختر الدولة الأصل' : 'اختر دولة الوجهة'}</span>
        `;
      });
      
      document.querySelectorAll('.country-dropdown').forEach(dropdown => {
        dropdown.classList.remove('active');
      });
      
      document.querySelectorAll('.country-select-trigger').forEach(trigger => {
        trigger.classList.remove('active');
      });
      
      showToast('تم تفريغ النموذج', 'info');
    };

    // إعداد الأحداث
    originCountry.onchange = () => updateCities(originCountry, originCity, originAirport);
    originCity.onchange = () => updateAirports(originCountry, originCity, originAirport);
    destinationCountry.onchange = () => updateCities(destinationCountry, destinationCity, destinationAirport);
    destinationCity.onchange = () => updateAirports(destinationCountry, destinationCity, destinationAirport);

    tabs.forEach(t => {
      t.onclick = () => {
        tabs.forEach(x => x.setAttribute('aria-pressed', 'false'));
        t.setAttribute('aria-pressed', 'true');
        tripType = t.dataset.type;
        returnGroup.style.display = tripType === 'oneway' ? 'none' : 'block';
      };
    });

    // تحميل البيانات
    loadData();
  </script>
</body>
</html>
